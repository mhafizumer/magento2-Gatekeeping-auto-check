name: Magento Code Quality Checks

on:
  pull_request:
    branches:
      - master
    types: [opened, synchronize, reopened]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality Checks

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: bcmath, ctype, curl, dom, gd, hash, iconv, intl, mbstring, openssl, pdo_mysql, simplexml, soap, xsl, zip
          tools: composer:v2

      - name: Get Composer Cache Directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: PHP Lint Check
        run: |
          echo "Running PHP Lint..."
          find . -path ./vendor -prune -o -name "*.php" -print0 | xargs -0 -n1 php -l
        continue-on-error: false

      - name: Configure PHPCS
        run: |
          vendor/bin/phpcs --config-set installed_paths vendor/magento/magento-coding-standard
          vendor/bin/phpcs --config-set default_standard Magento2

      - name: Run PHPCS
        run: |
          echo "Running PHPCS..."
          vendor/bin/phpcs --standard=Magento2 --extensions=php,phtml --ignore=vendor/,var/,pub/ ./app/code
        continue-on-error: false

      - name: Run PHPStan
        run: |
          echo "Running PHPStan..."
          vendor/bin/phpstan analyse app/code --level=5
        continue-on-error: false

      - name: Check for Raw SQL Queries
        run: |
          echo "Checking for raw SQL queries..."

          # Search for common raw query patterns
          FOUND=0

          # Check for direct queries using Connection
          if grep -r --include="*.php" --exclude-dir={vendor,var,pub} -E "(->query\(|->rawQuery\(|->fetchAll\(|->fetchOne\(|->fetchRow\()" ./app/code; then
            echo "❌ Found potential raw SQL queries using Connection methods"
            FOUND=1
          fi

          # Check for Zend_Db queries
          if grep -r --include="*.php" --exclude-dir={vendor,var,pub} -E "Zend_Db.*->query\(" ./app/code; then
            echo "❌ Found Zend_Db raw queries"
            FOUND=1
          fi

          # Check for direct SQL strings
          if grep -r --include="*.php" --exclude-dir={vendor,var,pub} -iE "(SELECT|INSERT|UPDATE|DELETE|CREATE|DROP|ALTER)[\s\*]+.*FROM.*WHERE" ./app/code | grep -v "//"; then
            echo "❌ Found potential raw SQL statements"
            FOUND=1
          fi

          if [ $FOUND -eq 1 ]; then
            echo ""
            echo "⚠️  RAW SQL DETECTED!"
            echo "Please use Magento's QueryBuilder, Repository pattern, or Resource Models instead."
            echo "Avoid using:"
            echo "  - \$connection->query()"
            echo "  - \$connection->rawQuery()"
            echo "  - Direct SQL strings"
            exit 1
          else
            echo "✅ No raw SQL queries detected"
          fi
        continue-on-error: false

      - name: Summary
        if: success()
        run: |
          echo "✅ All code quality checks passed!"
          echo "- PHP Lint: Passed"
          echo "- PHPCS (Magento2 Standard): Passed"
          echo "- PHPStan: Passed"
          echo "- Raw SQL Check: Passed"
