name: Magento Code Audit (PR)

on:
  workflow_run:
    workflows: ["Magento Quality Checks"]
    types:
      - completed
    branches:
      - '**'
permissions:
  contents: read
  pull-requests: write

jobs:
  audit:
    name: Code Review Report - Manual
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find changed Magento modules in PR
        id: mods
        shell: bash
        run: |
          set -euo pipefail

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          # Detect modules under app/code/<Vendor>/<Module> touched in the PR
          git diff --name-only "$BASE_SHA" "$HEAD_SHA" \
          | awk -F/ '
              /^app\/code\/[^/]+\/[^/]+\// { print $1"/"$2"/"$3"/"$4 }
            ' \
          | sort -u > modules.txt || true

          if [[ ! -s modules.txt ]]; then
            echo "found=0" >> "$GITHUB_OUTPUT"
            {
              echo "## ?? Magento Code Audit"
              echo ""
              echo "No Magento modules under \`app/code/<Vendor>/<Module>\` changed in this PR."
            } >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          echo "found=1" >> "$GITHUB_OUTPUT"

          {
            echo "modules<<EOF"
            cat modules.txt
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          echo "## ?? Magento Code Audit" >> "$GITHUB_STEP_SUMMARY"
          echo "### Magento modules detected" >> "$GITHUB_STEP_SUMMARY"
          sed 's/^/- `&`/' modules.txt >> "$GITHUB_STEP_SUMMARY"

      - name: Run code audits per module
        if: steps.mods.outputs.found == '1'
        id: audit
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p audit-reports
          SUMMARY_MD="audit-reports/summary.md"
          : > "$SUMMARY_MD"

          echo "### Audit will run for these module paths:" >> "$GITHUB_STEP_SUMMARY"
          while IFS= read -r CUSTOM_CODE; do
            [[ -z "$CUSTOM_CODE" ]] && continue
            echo "- \`$CUSTOM_CODE\`" >> "$GITHUB_STEP_SUMMARY"
          done < <(echo "${{ steps.mods.outputs.modules }}")

          # Re-loop to actually audit
          while IFS= read -r CUSTOM_CODE; do
            [[ -z "$CUSTOM_CODE" ]] && continue

            SAFE_NAME="$(echo "$CUSTOM_CODE" | sed 's#[/ ]#_#g')"
            REPORT_FILE="audit-reports/code_audit_${SAFE_NAME}_$(date +%Y%m%d).txt"

            {
              echo "MAGENTO CUSTOM CODE AUDIT REPORT"
              echo "Generated: $(date)"
              echo "Module Path: $CUSTOM_CODE"
              echo "======================================"
              echo ""

              echo "1. CUSTOM MODULES INVENTORY"
              find "$CUSTOM_CODE" -name "module.xml" -exec dirname {} \; | sort
              echo ""

              echo "2. SECURITY ISSUES"
              echo "--- Direct SQL queries (potential injection):"
              ( grep -RIn --include="*.php" -e "->query(" -- "$CUSTOM_CODE" || true ) | wc -l
              echo "--- Unvalidated input usage:"
              ( grep -RIn --include="*.php" -E "\$_GET|\$_POST|\$_REQUEST" -- "$CUSTOM_CODE" || true ) | wc -l
              echo "--- Unescaped output (XSS risk):"
              ( grep -RIn --include="*.phtml" -E "echo.*\$|print.*\$" -- "$CUSTOM_CODE" || true ) | wc -l
              echo ""

              echo "3. CODE QUALITY ISSUES"
              echo "--- Object Manager direct usage (anti-pattern):"
              ( grep -RIn --include="*.php" -e "ObjectManager::getInstance()" -- "$CUSTOM_CODE" || true ) | wc -l
              echo "--- Deprecated methods:"
              ( grep -RIn --include="*.php" -e "@deprecated" -- "$CUSTOM_CODE" || true ) | wc -l
              echo "--- TODO/FIXME/HACK comments:"
              ( grep -RIn --include="*.php" -E "TODO|FIXME|HACK" -- "$CUSTOM_CODE" || true ) | wc -l
              echo ""

              echo "4. PERFORMANCE CONCERNS"
              echo "--- Loops with database queries:"
              # -A must be before `--` (option) and wrap greps so no-matches don't fail the pipeline under pipefail
              { grep -RIn --include="*.php" -E "foreach[[:space:]]*\(.*\)[[:space:]]*\{" -A 10 -- "$CUSTOM_CODE" || true; } \
                | { grep -E "load\(|save\(" || true; } | wc -l
              echo "--- Collection usage (possible heavy operations, check for indexes/filters):"
              ( grep -RIn --include="*.php" -e "getCollection()" -- "$CUSTOM_CODE" || true ) | wc -l
              echo ""

              echo "5. MAGENTO BEST PRACTICES VIOLATIONS"
              echo "--- Direct instantiation of Magento classes (use DI instead):"
              ( grep -RIn --include="*.php" -E "new[[:space:]]+\\\\Magento\\\\|new[[:space:]]+Magento\\\\" -- "$CUSTOM_CODE" || true ) | wc -l
              echo "--- Calling load()/save() on models directly (prefer repositories):"
              ( grep -RIn --include="*.php" -E "->load\(|->save\(" -- "$CUSTOM_CODE" || true ) | wc -l
              echo "--- Direct use of \$_SESSION (use Magento Session managers):"
              ( grep -RIn --include="*.php" -e "\$_SESSION" -- "$CUSTOM_CODE" || true ) | wc -l
              echo ""
            } > "$REPORT_FILE"

            {
              echo "### ${CUSTOM_CODE}"
              echo "- Report: \`$REPORT_FILE\`"
              SEC=$(awk '/^2\. SECURITY ISSUES/{flag=1;next}/^$/{flag=0}flag' "$REPORT_FILE" | sed 's/^/  /')
              QUAL=$(awk '/^3\. CODE QUALITY ISSUES/{flag=1;next}/^$/{flag=0}flag' "$REPORT_FILE" | sed 's/^/  /')
              PERF=$(awk '/^4\. PERFORMANCE CONCERNS/{flag=1;next}/^$/{flag=0}flag' "$REPORT_FILE" | sed 's/^/  /')
              BEST=$(awk '/^5\. MAGENTO BEST PRACTICES VIOLATIONS/{flag=1;next}/^$/{flag=0}flag' "$REPORT_FILE" | sed 's/^/  /')
              echo ""
              echo "<details><summary>Quick counts</summary>"
              echo ""
              echo '```'
              echo "$SEC"
              echo ""
              echo "$QUAL"
              echo ""
              echo "$PERF"
              echo ""
              echo "$BEST"
              echo '```'
              echo "</details>"
              echo ""
            } >> "$SUMMARY_MD"

          done < <(echo "${{ steps.mods.outputs.modules }}")

          echo "summary_path=$SUMMARY_MD" >> "$GITHUB_OUTPUT"

      - name: Upload audit artifacts
        if: steps.mods.outputs.found == '1'
        uses: actions/upload-artifact@v4
        with:
          name: magento-code-audit-${{ github.run_id }}
          path: audit-reports/

      - name: Post PR comment
        if: steps.mods.outputs.found == '1'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const p = 'audit-reports/summary.md';
            let body = '';
            try {
              body = fs.readFileSync(p, 'utf8');
            } catch (e) {
              body = 'Audit completed. Reports uploaded as workflow artifacts.';
            }
            const header = `## Magento Code Audit\nArtifacts: **magento-code-audit-${process.env.GITHUB_RUN_ID}**\n\n`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: header + body
            });

      - name: Updating Job Summary
        if: steps.mods.outputs.found == '1'
        shell: bash
        run: |
          cat "audit-reports/summary.md" >> "$GITHUB_STEP_SUMMARY"



